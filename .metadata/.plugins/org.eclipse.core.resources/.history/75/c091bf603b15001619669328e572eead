package com.aiss.omnidrive.client.views.onedrive;

import java.util.Date;
import java.util.Map;

import com.aiss.omnidrive.client.controllers.OnedriveController;
import com.aiss.omnidrive.client.rpc.OAuthService;
import com.aiss.omnidrive.client.rpc.OAuthServiceAsync;
import com.aiss.omnidrive.client.rpc.OnedriveService;
import com.aiss.omnidrive.client.rpc.OnedriveServiceAsync;
import com.aiss.omnidrive.shared.OAuthToken;
import com.aiss.omnidrive.shared.drive.files.DriveFile;
import com.aiss.omnidrive.shared.onedrive.files.OnedriveFile;
import com.google.gwt.core.client.GWT;
import com.google.gwt.event.dom.client.ClickEvent;
import com.google.gwt.event.dom.client.ClickHandler;
import com.google.gwt.user.client.Cookies;
import com.google.gwt.user.client.Window;
import com.google.gwt.user.client.rpc.AsyncCallback;
import com.google.gwt.user.client.ui.Anchor;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.FlowPanel;
import com.google.gwt.user.client.ui.HTML;
import com.google.gwt.user.client.ui.Panel;

public class OnedriveFileDetailsView extends Composite {
	
	private final OAuthServiceAsync oauthService = GWT.create(OAuthService.class);
	private final OnedriveServiceAsync onedriveService = GWT.create(OnedriveService.class);
	
	public OnedriveFileDetailsView(Map<String, String> params){
		
		if (OnedriveController.isConnect()) {
			if (!OnedriveController.hasToken()) {
				oauthService.refreshToken("onedrive", Cookies.getCookie("onedriveToken"), new AsyncCallback<OAuthToken>() {
				@Override
				public void onSuccess(OAuthToken token) {
					// TODO Auto-generated method stub
					if (token.isCorrect()){
						Date tokenAccessExpireIn = new Date(new Date().getTime() + (token.getExpiresIn() * 1000));
						Cookies.setCookie("onedriveAccessToken", token.getAccessToken(), tokenAccessExpireIn);
					} else {
						Cookies.removeCookie("onedriveToken");
						Window.Location.replace(GWT.getHostPageBaseURL());
					}
				}
				@Override
					public void onFailure(Throwable caught) {
						// TODO Auto-generated method stub
						
					}
				});
			}

			final Panel detailsContent;
			detailsContent = new FlowPanel();
			onedriveService.getFile(Cookies.getCookie("onedriveAccessToken"), params.get("idFile"), new AsyncCallback<OnedriveFile>() {
				@Override
				public void onSuccess(OnedriveFile file) {
					// TODO Auto-generated method stub
					final Anchor iconClose;
					detailsContent.addStyleName("contenedorDetallesArchivo");
					iconClose = new Anchor("X");
					iconClose.removeStyleName("gwt-Anchor");
					iconClose.addStyleName("iconoCierre");
					detailsContent.add(iconClose);
					iconClose.addClickHandler(new ClickHandler() {
						
						@Override
						public void onClick(ClickEvent event) {
							// TODO Auto-generated method stub
							detailsContent.setVisible(false);
						}
					});
					
					HTML fileName = new HTML(file.getName());
					fileName.addStyleName("tituloDetallesArchivo");
					HTML fileType = new HTML();
					fileType.addStyleName("detallesArchivo");
					if (file.isDirectory()) {
						fileType.setText("Tipo: Carpeta");
					} else {
						fileType.setText("Tipo: " + file.getFile().getMimeType());
					}
					detailsContent.add(fileName);
					detailsContent.add(fileType);
					if (file.getCreatedBy() != null) {
						HTML fileOwner = new HTML("Creado por: " + file.getCreatedBy().getUser().getDisplayName());
						fileOwner.addStyleName("detallesArchivo");
						detailsContent.add(fileOwner);
					}
					HTML fileCreatedDate = new HTML("Creado el: " + file.getCreatedDateTime());
					fileCreatedDate.addStyleName("detallesArchivo");
					detailsContent.add(fileCreatedDate);
					HTML fileModifiedDate = new HTML("Modificado el: " + file.getLastModifiedDateTime());
					fileModifiedDate.addStyleName("detallesArchivo");
					detailsContent.add(fileCreatedDate);
				}
				
				@Override
				public void onFailure(Throwable caught) {
					// TODO Auto-generated method stub
					
				}
				
			});

			initWidget(detailsContent);
		}
		
	}

}
